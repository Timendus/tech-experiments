<html>
  <head> </head>
  <body>
    <div style="position: relative; display: inline-block">
      <img id="image" src="example.png" width="800" />
      <canvas
        id="canvas"
        style="position: absolute; left: 0; top: 0; width: 100%; height: 100%"
      ></canvas>
    </div>
    <form action="/feedbep" method="post" enctype="multipart/form-data">
      <textarea name="description"></textarea>
      <input type="file" name="attachment" id="plaatje" />
      <input type="submit" />
    </form>
  </body>
</html>

<script>
  function waitForEvent(element, eventName) {
    return new Promise((resolve, reject) => {
      const listener = (event) => {
        resolve(event);
        element.removeEventListener(eventName, listener);
      };
      element.addEventListener(eventName, listener);
    });
  }

  async function waitForImage(image) {
    if (image.complete && image.naturalWidth !== 0) {
      return;
    }
    await waitForEvent(image, "load");
  }

  function getEventCoords(event) {
    const rect = event.target.getBoundingClientRect();
    const x = (event.clientX - rect.left) / rect.width;
    const y = (event.clientY - rect.top) / rect.height;
    return { x, y };
  }

  function getRect(image, startDrag, endDrag) {
    return {
      x: Math.min(startDrag.x, endDrag.x) * image.naturalWidth,
      y: Math.min(startDrag.y, endDrag.y) * image.naturalHeight,
      width: Math.abs(startDrag.x - endDrag.x) * image.naturalWidth,
      height: Math.abs(startDrag.y - endDrag.y) * image.naturalHeight,
    };
  }

  function createPath(rects) {
    const path = new Path2D();
    for (const rect of rects) {
      path.rect(
        rect.x,
        rect.y,
        rect.width,
        rect.height,
        rect.x,
        rect.y,
        rect.width,
        rect.height
      );
    }
    return path;
  }

  function canvasToBlob(canvas, ...args) {
    return new Promise((resolve) => {
      canvas.toBlob((blob) => {
        resolve(blob);
      }, ...args);
    });
  }

  async function run() {
    const image = document.getElementById("image");
    await waitForImage(image);

    const canvas = document.getElementById("canvas");
    canvas.width = image.naturalWidth;
    canvas.height = image.naturalHeight;
    const context = canvas.getContext("2d");

    const rects = [];

    while (true) {
      const mousedownEvent = await waitForEvent(canvas, "mousedown");
      const startDrag = getEventCoords(mousedownEvent);

      context.clearRect(0, 0, canvas.width, canvas.height);

      function mousemove(event) {
        context.clearRect(0, 0, canvas.width, canvas.height);
        context.strokeStyle = "black";
        for (const rect of rects) {
          context.strokeRect(rect.x, rect.y, rect.width, rect.height);
        }

        const endDrag = getEventCoords(event);
        const rect = getRect(image, startDrag, endDrag);
        context.strokeRect(rect.x, rect.y, rect.width, rect.height);
      }
      canvas.addEventListener("mousemove", mousemove);
      const mouseupEvent = await waitForEvent(canvas, "mouseup");
      canvas.removeEventListener("mousemove", mousemove);
      const endDrag = getEventCoords(mouseupEvent);

      const rect = getRect(image, startDrag, endDrag);
      rects.push(rect);

      context.clearRect(0, 0, canvas.width, canvas.height);
      context.filter = "blur(20px)";
      context.drawImage(image, 0, 0);
      context.filter = "none";
      for (const rect of rects) {
        context.drawImage(
          image,
          rect.x,
          rect.y,
          rect.width,
          rect.height,
          rect.x,
          rect.y,
          rect.width,
          rect.height
        );
      }

      const blob = await canvasToBlob(canvas, "image/png");
      const file = new File([blob], "image.png");
      const dataTransfer = new DataTransfer();
      dataTransfer.items.add(file);
      document.getElementById("plaatje").files = dataTransfer.files;
    }
  }

  run();
</script>
