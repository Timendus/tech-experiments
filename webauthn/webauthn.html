<html>
  <head> </head>
  <body>
    CredentialId: <input type="text" id="credentialId" />
    <button onclick="register()">Register</button>
    <button onclick="authenticate()">Authenticate</button>
  </body>
</html>

<script>
  const username = "bobvanderlinden";
  const challenge = stringToArrayBuffer("abcde");
  const timeout = 60 * 4 * 1000;

  function stringToArrayBuffer(str) {
    const encoder = new TextEncoder();
    return encoder.encode(str);
  }

  function decodeBase64(base64) {
    return Uint8Array.from(JSON.parse(base64));
  }

  function encodeBase64(buffer) {
    JSON.stringify(buffer);
  }

  function decodeBase64(baseurl64String) {
    // Base64url to Base64
    const padding = "==".slice(0, (4 - (baseurl64String.length % 4)) % 4);
    const base64String =
      baseurl64String.replace(/-/g, "+").replace(/_/g, "/") + padding;

    // Base64 to binary string
    const str = atob(base64String);

    // Binary string to buffer
    const buffer = new ArrayBuffer(str.length);
    const byteView = new Uint8Array(buffer);
    for (let i = 0; i < str.length; i++) {
      byteView[i] = str.charCodeAt(i);
    }
    return buffer;
  }

  function encodeBase64(buffer) {
    // Buffer to binary string
    const byteView = new Uint8Array(buffer);
    let str = "";
    for (const charCode of byteView) {
      str += String.fromCharCode(charCode);
    }

    // Binary string to base64
    const base64String = btoa(str);

    // Base64 to base64url
    // We assume that the base64url string is well-formed.
    const base64urlString = base64String
      .replace(/\+/g, "-")
      .replace(/\//g, "_")
      .replace(/=/g, "");
    return base64urlString;
  }

  async function register() {
    const createResult = await window.navigator.credentials.create({
      publicKey: {
        rp: {
          id: window.location.hostname,
          name: window.location.hostname,
        },
        user: {
          displayName: username,
          id: stringToArrayBuffer(username),
          name: username,
        },
        challenge,
        pubKeyCredParams: [
          { type: "public-key", alg: -7 },
          { type: "public-key", alg: -257 },
        ],
        timeout,
        attestation: "none",
      },
    });
    document.getElementById("credentialId").value = encodeBase64(
      createResult.rawId
    );
  }

  async function authenticate() {
    const credentialId = decodeBase64(
      document.getElementById("credentialId").value
    );
    const getResult = await window.navigator.credentials.get({
      publicKey: {
        challenge,
        timeout,
        allowCredentials: [{ type: "public-key", id: credentialId }],
      },
    });
    console.log({ getResult });
  }
</script>
